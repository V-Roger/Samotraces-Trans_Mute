
<!doctype html>
<html>
    <head>
         <meta charset="utf-8">
        <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
  		<!--<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>-->
        <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js"></script>-->
        <script type="text/javascript" src="javascript/d3.js"></script>
        <!--<script type="text/javascript" src="javascript/jquery.js"></script>-->
        <script type="text/javascript" src="javascript/jquery.mousewheel.js"></script>
        <script type="text/javascript" src="../../../src/generate_samotraces.php"></script>
        <script type="text/javascript" src="javascript/Samotraces.js"></script>
        <script type="text/javascript" src="javascript/date_heure.js"></script>
        <link rel="stylesheet" type="text/css" href="css/samotraces.css"> 
        <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
		
    </head>
    <body>
	     <style type="text/css">
            #conteneur {
			  height: 1%;
			  overflow: hidden;
			}
			#conteneur div {
			  width: 50%;
			  float: left;
			}
		</style>	
        <div id="my-widget"></div>
        <div id="scale"></div>
        <div id="importer"></div>
        <div id="importer transformation"></div>
        <div id="obsel-inspector"></div>
        <div id="my-widget2"></div>
        <div id="scale2"></div>
        <div id="interaction-liste"></div>
        <div id="dialog" title="Boîte de dialogue Transformation" float: right;></div>
       
    <fieldset>  
         <legend >User Interaction</legend>
         <label >Time Stamp : </label><input type="text" id="TimeStamp" value="0">
         <label >Type :</label>
         <SELECT id="type" size="1">
           <OPTION>
           <OPTION>carre</OPTION>
           <OPTION>triangle</OPTION>
           <OPTION>cercle</OPTION>
         </SELECT> 
         <input type="text" id="attributes" value="couleur" disabled="disabled" size="5">
         <SELECT id="couleur" size="1">
           <OPTION>
           <OPTION>rouge</OPTION>
           <OPTION>jaune</OPTION>
           <OPTION>bleu</OPTION>
         </SELECT><br><br>
         
         <button id="add-obs" >Ajouter Obsel</button>
         <button id="modify-obs" disabled="disabled" >Transformer Obsel</button>
         <button id="delete-obs" disabled="disabled">Supprimer Obsel</button>
		 
         <div id="conteneur">
		  <br><div id="modifier"><fieldset><legend >modifier obsel</legend> </fieldset></div>
		  <div>
          <form action="./" method="post">
          <br><div align="right"><textarea cols="73" rows="10" id="historique" ></textarea></div>
		  </div>
		  </div>
          <br><div align="right"><a href="#" class="blueButton" id="download" >Download</a></div>
		  
          </form>
		 
    </fieldset> 
        <div id="obsel-inspector2"></div>
         
        <script type="text/javascript">
        function init() {
            // Create logical objects
			
			document.getElementById('historique').value=" " ;
			
            var trace        = new Samotraces.Lib.DemoTrace();
			var trace_Transformation = new Samotraces.Lib.DemoTrace();
            var tw           = new Samotraces.Lib.TimeWindow({start: 0,end: 20});
			var tw2          = new Samotraces.Lib.TimeWindow({start: 0,end: 20});
            var obsel_selector    = new Samotraces.Lib.Selector('Obsel','multiple');
			//var obsel_selector2    = new Samotraces.Lib.Selector('Obsel');
			
            //Visualisation options
            var options = { 
            url:  function(o) {
				 
                 return 'images/'+o.type+' '+o.attributes.couleur+'.png';
                },
                width: 25,
                height: 40,
                y: 0,
				
			};
			
			var options2 = { 
            url:  function(o) {
                 return 'images/'+o.type+' '+o.attributes.couleur+'.png';
                },
                width: 25,
                height: 40,
                y: 0,
				
			};    
			     
			//create widgets
			new Samotraces.Widgets.TraceDisplayIcons('my-widget',trace,tw,options);
			var visu=new Samotraces.Widgets.TraceDisplayIcons('my-widget2',trace_Transformation,tw2,options2);
			new Samotraces.Widgets.WindowScale('scale',tw);
			new Samotraces.Widgets.WindowScale('scale2',tw2);
			new Samotraces.Widgets.ImportTrace('importer',trace);
			new Samotraces.Widgets.ImportTrace('importer transformation',trace_Transformation);
			//new Samotraces.Widgets.ObselInspector('obsel-inspector',obsel_selector);
			//new Samotraces.Widgets.ObselInspector('obsel-inspector2',obsel_selector2);
	       // Adding behaviour when clicking on obsels using jQuery
			$('body').on('click','.Σ-obsel',function(e) {
				var obs = $.data(e.target,'Σ-data');
				obsel_selector.toggle(obs);
			});
			
			trace.addEventListener('trace:create:obsel',function(e) {
				var o = e.data;
				
				trace_Transformation.newObsel(o.type,o.timestamp,o.attributes);
			});

			obsel_selector.addEventListener('selection:add', function(e) {
				$("#delete-obs").prop("disabled",false);
				$("#modify-obs").prop("disabled",false);
				
				var obs = e.data;
				function create_points(obs) {
					var x = visu.options.x(obs);
					return String.concat(x+3,",10,",x+8,",15,",x+13,",10");
				}
				visu.svg
					.append('polygon')
					.attr('points',create_points(obs))
					.attr('stroke-width','1px')
					.attr('stroke','black')
					.attr('id',"__OBSEL__"+obs.id);
			});
			

			obsel_selector.addEventListener('selection:remove', function(e) {
				if(obsel_selector.is_empty()) {
					$("#delete-obs").prop("disabled",true);
					$("#modify-obs").prop("disabled",true);
				}
				var obs = e.data;
				$('#__OBSEL__'+obs.id).remove();
			});
			
			obsel_selector.addEventListener('selection:empty', function() {
					$("#delete-obs").prop("disabled",true);
					$("#modify-obs").prop("disabled",true);
				visu.svg.selectAll('polygon').remove();
			});
			
			tw2.addEventListener('tw:update',function() {
				function update_points(p) {
					var id = $(p).attr('id');
					var obs = trace_Transformation.getObsel(id.substr(9));
					var x = visu.options.x(obs);
					return String.concat(x+3,",10,",x+8,",15,",x+13,",10");
				}
				$('polygon').each(function(i,p) {
				console.log(p);
					$(p).attr('points',update_points(p));
				})
			});
			
			
			//Crud Trace
			 var i=0;
			 var Transformation_Interaction=[];
			 var date = date_heure();
			 var texte = "";
			 
			$("#delete-obs").click(function() { 
				i++;
				var obsels_source_delete = [];
				obsel_selector.selection.forEach(function(obs) {
					obsels_source_delete.push({
						idObs : obs.id,
						timestamp : obs.timestamp,
						type : obs.type,
						attributes : obs.attributes ,							
					});				
					trace_Transformation.removeObsel(obs);
				});
				Transformation_Interaction.push({
					id_interaction : i,
					date : date,
					even : "trace:remove:obsel" ,
					obsels_source : obsels_source_delete				
				}); // TODO implémenter un get_selection
				obsel_selector.empty();
				texte = JSON.stringify(Transformation_Interaction);
			    document.getElementById('historique').value=texte;
			});	
		    
			$("#add-obs").click(function() {
			  i++;
			  var obsels_source_add=[] ;
			  var attributes = {};
			  attributes[document.getElementById('attributes').value] =document.getElementById('couleur').value ;
			  var type = document.getElementById('type').value ;
			  var time = document.getElementById('TimeStamp').value ;
		
			  trace_Transformation.newObsel(type,time,attributes);	
			   obsels_source_add.push({
			        idObs : 0,//getid
					timestamp : time,
					type : type,
					attributes : attributes 
					});
			  Transformation_Interaction.push({
					id_interaction : i,
					date : date,
					even : "trace:create:obsel" ,
					obsels_source : obsels_source_add				
				   });
				   
		         texte = JSON.stringify(Transformation_Interaction);
				 document.getElementById('historique').value=texte ;
				});
			
				 
			$("#modify-obs").click(function() {
                i++;
				var obsels_source_modify=[] ;
				var obsels_source_transformer=[];
				obsel_selector.selection.forEach(function(obs) {
					
					
					obsels_source_modify.push({
						idObs : obs.id,
						timestamp : obs.timestamp,
						type : obs.type,
						attributes : obs.attributes ,
					    
						
					});
				
				//trace_Transformation.updateObsel(obs,new_obs);
				trace_Transformation.removeObsel(obs);
				obsel_selector.unselect(obs);
				//obsel_selector.select(new_obs);
				});
				
			   //var new_obs = new Samotraces.Lib.Obsel(obs.id,obs.timestamp,obs.type,obs.attributes);
				time =document.getElementById('TimeStamp').value ;
				type =document.getElementById('type').value;
				attributes[document.getElementById('attributes').value] = document.getElementById('couleur').value ;
				
				trace_Transformation.newObsel(type,time,attributes);
				/*
				obsels_source_transformer.push({
						
						
					});
				*/	
				Transformation_Interaction.push({
					id_interaction : i,
					date : date,
					even : "trace:update:obsel" ,
					obsels_source : obsels_source_modify,
					//obsels_Transformer : obsels_source_transformer
					even_Tran : "trace:update:obsel" ,
					timestamp_Tran : time,
					type_Tran : type,
					attributes_Tran : attributes, 					
				});   
			texte = JSON.stringify(Transformation_Interaction);
			document.getElementById('historique').value=texte ;
				  
			});	
			
			
			//>>
			/*
			obsel_selector.addEventListener('selection:add', function(e) {
					//var texte = prompt("Entrez le texte à placer dans #mon_element");
					var obs = e.data;
					
					var new_element = jQuery('<br><div id="mef"></div>');
					//$('#modifier').html( $('#modifier').html() +'\n'+' salut' );
					
		            //var nouvelle_ligne = $('<div><span>'+ input_element +'</span></div>');
					
					$('<input>', {
						id: obs.id,
						value: obs.type, 
						size : 0
					}).appendTo(new_element);
					
					$('<input>', {
						id: obs.id,
						value: 'couleur' ,
						disabled:'disabled' ,
						size : 5 
					}).appendTo(new_element);
					
					$('<input>', {
						id: obs.id,
						value: obs.attributes.couleur ,
						size : 5  
					}).appendTo(new_element);
					
				    $('#m').append(new_element);
					
					
					
			});
			obsel_selector.addEventListener('selection:remove', function(e) {
				if(obsel_selector.is_empty()) {
					
					var obs = e.data;
					var id = "'#mef"+obs.id+"'" ;
					alert(id);
					//$(id).remove();
				}
				
			});
			
			//<<
			*/

	}

// calling the init function when the DOM has been loaded
window.addEventListener('DOMContentLoaded', init );
        </script>
         <script src="assets/js/jquery.generateFile.js"></script>
         <script src="assets/js/script.js"></script> 
         
           
    </body>
</html>